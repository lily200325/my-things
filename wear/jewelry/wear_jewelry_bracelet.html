<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹é•¯</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <div class="container">
        <div class="search-bar">
            <input type="text" placeholder="æœç´¢...">
            <div class="action-buttons">
                <button class="export-btn" onclick="exportData()">å¯¼å‡º</button>
                <button onclick="importData()">å¯¼å…¥</button>
            </div>
        </div>
        <div class="header">
            <a href="wear_jewelry.html" class="back-button">â†</a>
        </div>

        <!-- æ·»åŠ ç‰©å“æŒ‰é’® -->
        <button class="add-item-button" onclick="showAddForm()">+ æ·»åŠ è¡£ç‰©</button>

        <!-- ç‰©å“å±•ç¤ºåŒºåŸŸ -->
        <div class="items-container">
            <!-- æ·»åŠ æ–°ç‰©å“çš„å¡ç‰‡ -->
            <div class="item-card add-new-card" style="display: none;">
                <div class="image-upload" onclick="document.getElementById('imageUpload').click()">
                    <input type="file" accept="image/*" id="imageUpload" onchange="previewImage(event)">
                    <div class="placeholder">
                        <span class="emoji">ğŸ“¸</span>
                        <p>ç‚¹å‡»æ·»åŠ å›¾ç‰‡</p>
                    </div>
                </div>
                <input type="text" class="location-input" placeholder="è¾“å…¥ä½ç½®...">
                <button class="save-button" onclick="saveItem()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºæ•°æ®å¼¹çª— -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>å¯¼å‡ºæ•°æ®</h3>
            <textarea id="exportData" readonly></textarea>
            <div class="modal-buttons">
                <button class="copy-btn" onclick="copyExportData()">å¤åˆ¶</button>
                <button class="close-btn" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let db;
        const request = indexedDB.open('ClothesDB', 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('clothes')) {
                db.createObjectStore('clothes', { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            renderItems();
        };
        request.onerror = function() {
            alert('æ•°æ®åº“æ‰“å¼€å¤±è´¥');
        };

        function addCloth(image, location) {
            const tx = db.transaction('clothes', 'readwrite');
            const store = tx.objectStore('clothes');
            store.add({ image, location });
            tx.oncomplete = renderItems;
        }

        function renderItems() {
            const tx = db.transaction('clothes', 'readonly');
            const store = tx.objectStore('clothes');
            const req = store.getAll();
            req.onsuccess = function() {
                const items = req.result;
                const container = document.getElementById('itemsContainer');
                // Clear existing items except the add new card
                const existingItems = container.querySelectorAll('.item-card:not(.add-new-card)');
                existingItems.forEach(item => item.remove());

                items.forEach((item) => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.dataset.id = item.id;
                    card.innerHTML = `
                        <button class="delete-btn" onclick="deleteItem(${item.id})">Ã—</button>
                        <div class="image-container">
                            <img src="${item.image}" alt="ç‰©å“å›¾ç‰‡" class="image-preview">
                        </div>
                        <div class="location-text editable" ondblclick="makeEditable(this)">${item.location}</div>
                    `;
                     container.insertBefore(
                        card,
                        document.querySelector('.add-new-card')
                    );
                });
            }
        }

        window.deleteItem = function(id) {
            const tx = db.transaction('clothes', 'readwrite');
            const store = tx.objectStore('clothes');
            store.delete(id);
            tx.oncomplete = function() {
                 document.querySelector(`[data-id="${id}"]`).remove();
            };
            tx.onerror = function() {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        function showAddForm() {
            document.querySelector('.add-new-card').style.display = 'block';
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const placeholder = document.querySelector('.placeholder');
                    placeholder.innerHTML = `<img src="${e.target.result}" class="image-preview">`;
                }
                reader.readAsDataURL(file);
            }
        }

        function saveItem() {
            const locationInput = document.querySelector('.location-input');
            const imagePreview = document.querySelector('.add-new-card .image-preview');
            const imageData = imagePreview ? imagePreview.src : null;

            if (!imageData || !locationInput.value) {
                alert('è¯·æ·»åŠ å›¾ç‰‡å’Œä½ç½®ä¿¡æ¯');
                return;
            }

            addCloth(imageData, locationInput.value);

            // é‡ç½®è¡¨å•
            document.querySelector('.placeholder').innerHTML = '<span class="emoji">ğŸ“¸</span><p>ç‚¹å‡»æ·»åŠ å›¾ç‰‡</p>';
            locationInput.value = '';
            document.querySelector('.add-new-card').style.display = 'none';
             if (imagePreview) imagePreview.remove();
        }

        function makeEditable(element) {
            element.contentEditable = true;
            element.classList.add('editing');
            element.focus();

            const originalText = element.textContent;

            function saveEdit() {
                element.contentEditable = false;
                element.classList.remove('editing');
                const itemId = parseInt(element.parentElement.dataset.id);
                const tx = db.transaction('clothes', 'readwrite');
                const store = tx.objectStore('clothes');
                store.get(itemId).onsuccess = function(event) {
                    const item = event.target.result;
                    if (item) {
                        item.location = element.textContent;
                        store.put(item);
                        tx.oncomplete = function() {
                            console.log('Location updated in IndexedDB');
                        };
                         tx.onerror = function() {
                            console.error('Failed to update location in IndexedDB');
                        };
                    }
                };
            }

            function cancelEdit() {
                element.textContent = originalText;
                element.contentEditable = false;
                element.classList.remove('editing');
            }

            element.addEventListener('blur', saveEdit);
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        function exportData() {
            const tx = db.transaction('clothes', 'readonly');
            const store = tx.objectStore('clothes');
            const req = store.getAll();
            req.onsuccess = function() {
                const items = req.result;
                 const exportData = {
                    type: document.querySelector('h1').textContent.replace('ç®¡ç†',''),
                    items: items
                };
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${exportData.type}_ç‰©å“åˆ—è¡¨.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Assuming importedData.items is an array of items
                        if (Array.isArray(importedData.items)) {
                            const tx = db.transaction('clothes', 'readwrite');
                            const store = tx.objectStore('clothes');
                            store.clear(); // Clear existing data
                            importedData.items.forEach(item => {
                                // Add imported items, let IndexedDB generate new IDs
                                store.add({ image: item.image, location: item.location });
                            });
                            tx.oncomplete = function() {
                                alert('å¯¼å…¥æˆåŠŸï¼');
                                renderItems();
                            };
                             tx.onerror = function() {
                                alert('å¯¼å…¥å¤±è´¥');
                            };
                        } else {
                            alert('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                        }
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

    </script>
</body>
</html> 